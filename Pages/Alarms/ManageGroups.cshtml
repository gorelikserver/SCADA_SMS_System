@page
@model SCADASMSSystem.Web.Pages.Alarms.ManageGroupsModel
@{
    ViewData["Title"] = "Manage Alarm Group Assignments";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <h1 class="mb-0">
                        <i class="fas fa-bell me-2"></i>
                        Manage Alarm Group Assignments
                    </h1>
                    <p class="mb-0 mt-2">
                        Configure which SMS groups receive notifications for each SCADA alarm
                        <br />
                        <small><i class="fas fa-info-circle me-1"></i>Note: Each alarm can be assigned to multiple groups</small>
                    </p>
                </div>
            </div>

            <!-- Success/Error Messages -->
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-7">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       class="form-control" 
                                       name="searchTerm" 
                                       value="@Model.SearchTerm" 
                                       placeholder="Search by block name, alarm ID, or description..." />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select name="pageSize" class="form-select" onchange="this.form.submit()">
                                <option value="10" selected="@(Model.PageSize == 10)">10 per page</option>
                                <option value="25" selected="@(Model.PageSize == 25)">25 per page</option>
                                <option value="50" selected="@(Model.PageSize == 50)">50 per page</option>
                                <option value="100" selected="@(Model.PageSize == 100)">100 per page</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                        <input type="hidden" name="page" value="1" />
                    </form>
                </div>
            </div>

            <!-- Alarms Table -->
            <div class="card">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            SCADA Alarms
                        </h5>
                        <span class="badge bg-primary">
                            Showing @Model.AlarmAssignments.Count() of @Model.TotalItems alarms
                            @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
                            {
                                <text>(filtered)</text>
                            }
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (!Model.AlarmAssignments.Any())
                    {
                        <div class="alert alert-info m-4">
                            <i class="fas fa-info-circle me-2"></i>
                            No alarms found. @(!string.IsNullOrWhiteSpace(Model.SearchTerm) ? "Try a different search term." : "")
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 15%;">Block Name</th>
                                        <th style="width: 15%;">Alarm ID</th>
                                        <th style="width: 25%;">Description</th>
                                        <th style="width: 20%;">Assigned Groups</th>
                                        <th style="width: 15%;">Last Modified</th>
                                        <th style="width: 10%;" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var alarm in Model.AlarmAssignments)
                                    {
                                        <tr>
                                            <td>
                                                <span class="block-name">@alarm.BlockName</span>
                                                @if (!alarm.IsActive)
                                                {
                                                    <span class="badge bg-secondary ms-2">Inactive</span>
                                                }
                                            </td>
                                            <td>
                                                <code>@(alarm.AlarmId ?? "N/A")</code>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    @(alarm.AlarmDescription ?? "No description")
                                                </small>
                                            </td>
                                            <td>
                                                @if (alarm.AssignedGroups != null && alarm.AssignedGroups.Any())
                                                {
                                                    foreach (var group in alarm.AssignedGroups)
                                                    {
                                                        <span class="badge bg-info text-dark me-1 mb-1">
                                                            <i class="fas fa-users me-1"></i>
                                                            @group.GroupName
                                                        </span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        No groups assigned
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                @if (alarm.LastModified.HasValue)
                                                {
                                                    <small>
                                                        @alarm.LastModified.Value.ToString("dd/MM/yyyy HH:mm")
                                                        @if (!string.IsNullOrWhiteSpace(alarm.ModifiedBy))
                                                        {
                                                            <br /><span class="text-muted">by @alarm.ModifiedBy</span>
                                                        }
                                                    </small>
                                                }
                                                else
                                                {
                                                    <small class="text-muted">Never modified</small>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <button type="button" 
                                                        class="btn btn-sm btn-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#manageGroupModal"
                                                        onclick="openManageGroupModal(@alarm.BlockId, '@alarm.BlockName', [@string.Join(",", alarm.AssignedGroupIds)])">
                                                    <i class="fas fa-edit me-1"></i>
                                                    Manage
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        @if (Model.TotalPages > 1)
                        {
                            <div class="card-footer">
                                <nav aria-label="Alarm pagination">
                                    <ul class="pagination justify-content-center mb-0">
                                        <!-- First Page -->
                                        <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                                            <a class="page-link" href="?page=1&pageSize=@Model.PageSize@(string.IsNullOrWhiteSpace(Model.SearchTerm) ? "" : "&searchTerm=" + Uri.EscapeDataString(Model.SearchTerm))" aria-label="First">
                                                <span aria-hidden="true">&laquo;&laquo;</span>
                                            </a>
                                        </li>

                                        <!-- Previous Page -->
                                        <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                                            <a class="page-link" href="?page=@(Model.CurrentPage - 1)&pageSize=@Model.PageSize@(string.IsNullOrWhiteSpace(Model.SearchTerm) ? "" : "&searchTerm=" + Uri.EscapeDataString(Model.SearchTerm))" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>

                                        <!-- Page Numbers -->
                                        @{
                                            var startPage = Math.Max(1, Model.CurrentPage - 2);
                                            var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                                        }

                                        @if (startPage > 1)
                                        {
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                        }

                                        @for (var i = startPage; i <= endPage; i++)
                                        {
                                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                                <a class="page-link" href="?page=@i&pageSize=@Model.PageSize@(string.IsNullOrWhiteSpace(Model.SearchTerm) ? "" : "&searchTerm=" + Uri.EscapeDataString(Model.SearchTerm))">@i</a>
                                            </li>
                                        }

                                        @if (endPage < Model.TotalPages)
                                        {
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                        }

                                        <!-- Next Page -->
                                        <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                                            <a class="page-link" href="?page=@(Model.CurrentPage + 1)&pageSize=@Model.PageSize@(string.IsNullOrWhiteSpace(Model.SearchTerm) ? "" : "&searchTerm=" + Uri.EscapeDataString(Model.SearchTerm))" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>

                                        <!-- Last Page -->
                                        <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                                            <a class="page-link" href="?page=@Model.TotalPages&pageSize=@Model.PageSize@(string.IsNullOrWhiteSpace(Model.SearchTerm) ? "" : "&searchTerm=" + Uri.EscapeDataString(Model.SearchTerm))" aria-label="Last">
                                                <span aria-hidden="true">&raquo;&raquo;</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="text-center mt-2">
                                    <small class="text-muted">
                                        Page @Model.CurrentPage of @Model.TotalPages 
                                        (Showing @((Model.CurrentPage - 1) * Model.PageSize + 1)-@Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalItems) of @Model.TotalItems alarms)
                                    </small>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manage Group Modal (Checkboxes - Multiple Selection) -->
<div class="modal fade" id="manageGroupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-users-cog me-2"></i>
                    Manage Group Assignments
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="BulkUpdate" id="manageGroupForm" onsubmit="return prepareGroupSubmission()">
                <div class="modal-body">
                    <input type="hidden" name="blockId" id="modalBlockId" />
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Alarm Block:</strong> <span id="modalBlockName"></span>
                        <br />
                        <small><i class="fas fa-check-square me-1"></i>Select groups to receive notifications, or uncheck all to disable SMS alerts for this alarm</small>
                    </div>

                    <h6 class="mb-3">Select SMS Groups:</h6>
                    
                    <div class="list-group" id="groupCheckboxList">
                        @foreach (var group in Model.AllGroups)
                        {
                            <label class="list-group-item list-group-item-action">
                                <div class="d-flex align-items-center">
                                    <input class="form-check-input me-2 group-checkbox" 
                                           type="checkbox" 
                                           name="selectedGroupCheckbox" 
                                           value="@group.GroupId" />
                                    <div class="flex-grow-1">
                                        <strong>@group.GroupName</strong>
                                        <br />
                                        <small class="text-muted">
                                            <i class="fas fa-users me-1"></i>
                                            @group.GroupMembers.Count() member(s)
                                        </small>
                                    </div>
                                </div>
                            </label>
                        }
                    </div>

                    @if (!Model.AllGroups.Any())
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No groups available. Please create groups first.
                        </div>
                    }

                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllGroups()">
                            <i class="fas fa-times-circle me-1"></i>
                            Remove All Groups (Disable SMS)
                        </button>
                        <small class="text-muted ms-2">
                            <i class="fas fa-info-circle"></i>
                            This will remove SMS notifications but preserve other alarm actions
                        </small>
                    </div>

                    <input type="hidden" name="selectedGroups" id="selectedGroupsInput" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openManageGroupModal(blockId, blockName, currentGroupIds) {
            // Set modal title and hidden field
            document.getElementById('modalBlockId').value = blockId;
            document.getElementById('modalBlockName').textContent = blockName;

            // Select the current group checkboxes
            var checkboxes = document.querySelectorAll('.group-checkbox');
            checkboxes.forEach(function(checkbox) {
                var groupId = parseInt(checkbox.value);
                checkbox.checked = currentGroupIds.includes(groupId);
            });
        }

        function clearAllGroups() {
            // Uncheck all checkboxes
            var checkboxes = document.querySelectorAll('.group-checkbox');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = false;
            });
            
            // Highlight that all groups were cleared
            var alertDiv = document.querySelector('#manageGroupModal .alert-info');
            alertDiv.classList.remove('alert-info');
            alertDiv.classList.add('alert-warning');
            alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>All SMS groups will be removed!</strong><br /><small>Other alarm actions will be preserved.</small>';
            
            // Reset after 3 seconds
            setTimeout(function() {
                alertDiv.classList.remove('alert-warning');
                alertDiv.classList.add('alert-info');
                alertDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i><strong>Alarm Block:</strong> <span id="modalBlockName">' + 
                    document.getElementById('modalBlockName').textContent + 
                    '</span><br /><small><i class="fas fa-check-square me-1"></i>Select groups to receive notifications, or uncheck all to disable SMS alerts for this alarm</small>';
            }, 3000);
        }

        function prepareGroupSubmission() {
            // Get all checked checkboxes
            var checkedBoxes = document.querySelectorAll('.group-checkbox:checked');
            
            // Allow zero selections to remove all groups
            var selectedGroupIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            // Set the hidden input value (comma-separated list, or empty for no groups)
            document.getElementById('selectedGroupsInput').value = selectedGroupIds.join(',');
            
            // Confirm if removing all groups
            if (selectedGroupIds.length === 0) {
                return confirm('You have selected NO groups. This will REMOVE all SMS notifications for this alarm.\n\nOther alarm actions (like WF commands) will be preserved.\n\nContinue?');
            }
            
            return true; // Allow form submission
        }

        // Auto-dismiss alerts after 5 seconds
        setTimeout(function() {
            var alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(function(alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
}

@section Styles {
    <style>
        .list-group-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
        }

        .list-group-item input[type="checkbox"]:checked ~ div {
            font-weight: bold;
        }

        .list-group-item:has(input[type="checkbox"]:checked) {
            background-color: #e7f3ff;
            border-color: #0d6efd;
        }

        .badge {
            font-size: 0.8rem;
            padding: 0.35em 0.65em;
        }

        .table td {
            vertical-align: middle;
        }

        /* Make block name font weight normal (not bold) */
        .block-name {
            font-weight: normal;
        }

        code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            color: #d63384;
        }

        /* Pagination styling */
        .pagination {
            margin-top: 0.5rem;
        }

        .page-link {
            color: #0d6efd;
        }

        .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .card-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
    </style>
}
